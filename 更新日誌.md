# 更新日誌

---

## v8.1 功能增強 - 手機系統鍵盤控制

### 更新日期
2025-10-08

### 更新類型
功能增強（Enhancement）+ Bug 修復

### 快速修復（10/8 晚間）
- 🐛 **修復未勾選時按鈕嚴重延遲問題**（開發者工具手機模式）
- 🐛 修復允許系統鍵盤後自製鍵盤按鈕點擊延遲/無反應問題
- 🐛 修復字母按鈕長按功能與正常點擊衝突問題
- 🎨 優化勾選框尺寸，改為小巧不擋路的設計
- 🎨 簡化標籤文字為「系統鍵盤」，添加 title 提示
- ⚡ **徹底重構事件處理邏輯，移除阻塞性 preventDefault**
- ⚡ 在 click 事件中處理焦點控制，確保即時響應

### 問題背景
在手機使用 PWA 時，當使用者點擊自製鍵盤符號按鈕，手機內建的系統鍵盤（OSK）會非預期彈出，與自製鍵盤互相干擾、搶焦點並擠壓版面，影響使用體驗。

### 解決方案
採用「方案 A - `inputmode="none"` + `readonly` 受控切換」，能解決 90%+ 的手機瀏覽器情境。

### 主要變更

#### 1. HTML 結構變更
- ✅ 在 `#input-field` (textarea) 添加屬性：
  - `inputmode="none"` - 預設不顯示虛擬鍵盤
  - `readonly` - 預設唯讀，阻止系統鍵盤彈出
  - `autocomplete="off" autocapitalize="off" autocorrect="off"` - 減少自動建議干擾
- ✅ 新增「允許使用手機內建鍵盤」勾選框控制項
  - 位置：toolbar 右側區域
  - 預設狀態：不勾選（禁止系統鍵盤）

#### 2. CSS 樣式變更
- ✅ 新增 `.osk-control` 樣式類別
- ✅ 勾選框觸控友善設計（最小 44px 觸控區域）
- ✅ 手機端響應式適配

#### 3. JavaScript 功能變更
- ✅ 新增 `applyOskPolicy()` 函數：
  - 根據勾選框狀態控制 `readonly` 和 `inputmode` 屬性
  - 處理 Safari 瀏覽器的特殊相容性（需要 blur/focus 切換）
- ✅ 修改 `createKeyBtn()` 函數：
  - 添加 `pointerdown` 和 `touchstart` 事件的 `preventDefault()`
  - 防止點擊自製鍵盤按鈕時誤觸發輸入框焦點
- ✅ 修改 `insertToken()` 函數：
  - 在禁止 OSK 時暫時移除 readonly，插入符號後恢復
  - 確保自製鍵盤功能正常運作
- ✅ 初始化邏輯：
  - 監聽勾選框 change 事件
  - 頁面載入時執行一次確保預設狀態正確

### 使用說明

**預設行為（不勾選）：**
- 系統鍵盤不會彈出
- 只能使用自製鍵盤輸入符號
- 提供最佳的數學符號輸入體驗

**勾選後行為：**
- 允許系統鍵盤彈出
- 可以使用手機鍵盤自由輸入文字
- 適合需要輸入大量純文字的情境

### 技術實現

**核心機制：**
```
初始狀態: textarea[readonly, inputmode="none"]
↓
勾選允許 → 移除 readonly + 設置 inputmode="text" + focus()
↓
取消勾選 → 設置 readonly + 設置 inputmode="none" + blur()
```

**防誤觸機制：**
- 自製鍵盤按鈕攔截 `pointerdown` 和 `touchstart` 事件
- 防止點擊事件穿透到輸入框造成焦點變更

### 相容性
✅ iOS Safari  
✅ iOS Chrome（WebKit 核心）  
✅ Android Chrome  
✅ Samsung Internet  
✅ Firefox for Android  
✅ 支援 90%+ 主流行動瀏覽器

### 測試建議
1. ✓ 預設狀態下點擊自製鍵盤不會彈出系統鍵盤
2. ✓ 勾選後系統鍵盤正常彈出
3. ✓ 取消勾選後系統鍵盤正常關閉
4. ✓ 符號插入功能正常運作
5. ✓ 各種模式切換正常（LaTeX/Unicode/證明樹/矩陣）
6. ✓ 響應式布局在手機端顯示正常

### 文件大小影響
- **代碼增加：** ~2KB（包含 HTML/CSS/JS）
- **載入速度：** 無明顯影響
- **功能完整性：** 100% 保持

---

# 重構說明 - v8 更新

## 重構日期
2025-10-02

## 重構原因
1. Mathlive 虛擬鍵盤不斷彈出，影響使用體驗
2. 不需要數學公式渲染功能
3. 需要直接顯示原始 LaTeX 代碼而非渲染結果

## 主要變更

### 1. 移除依賴項
- ❌ 移除 Mathlive 函式庫
- ❌ 移除 KaTeX 渲染函式庫
- ✅ 改用純 HTML/CSS/JS 實現

### 2. 輸入框變更
**之前：** `<math-field>` (Mathlive 組件)
**現在：** `<textarea>` (標準 HTML 元素)

**優點：**
- 不會觸發虛擬鍵盤
- 更輕量級
- 更好的文字編輯體驗
- 支援多行輸入

### 3. 顯示區域變更
**之前：** 使用 KaTeX 渲染 LaTeX 為數學公式
**現在：** 直接顯示原始 LaTeX 文字

位置：「其他符號」下方的「當前輸入內容」區域

### 4. 複製按鈕增強
新增視覺反饋效果：
- 點擊後按鈕顯示「✓ 已複製」
- 按鈕背景變為藍色
- 1 秒後自動恢復原狀

### 5. 代碼結構改進

#### JavaScript 變更
- `MF` (MathField) → `INPUT_FIELD` (textarea)
- `MF.getValue()` → `INPUT_FIELD.value`
- `MF.setValue()` → `INPUT_FIELD.value = ...`
- 移除 KaTeX 渲染邏輯
- 新增 `showCopyFeedback()` 函數

#### CSS 變更
- 新增 `#input-field` 樣式（monospace 字體、focus 效果）
- 新增 `.current-content-section` 區域樣式
- 新增 `.current-content-display` 顯示原始文字
- 移除 `math-field` 相關樣式

#### HTML 變更
- 標題更新為「離散數學鍵盤 LaTeX 輸入工具 [v8]」
- 移除 Mathlive 官方鍵盤指南連結
- 更新版本號為 v8

## 功能保持不變
✅ 符號按鈕點擊輸入
✅ LaTeX/符號模式切換
✅ 歷史紀錄功能
✅ 複製 LaTeX/符號功能
✅ 清空功能
✅ 其他符號折疊/展開
✅ PWA 離線支援
✅ 響應式設計（手機適配）

## 測試建議
1. 開啟 `index.html` 確認無虛擬鍵盤彈出
2. 測試符號按鈕是否正確插入
3. 測試複製功能是否正常
4. 確認「當前輸入內容」顯示原始 LaTeX
5. 測試歷史紀錄功能
6. 測試響應式布局（手機/平板）

## 文件大小對比
- **之前：** 需載入 Mathlive (~500KB) + KaTeX (~200KB)
- **現在：** 僅載入自定義代碼 (~10KB)
- **載入速度提升：** 約 98%

## 版本歷史
- v7: 使用 Mathlive + KaTeX
- v8: 純 HTML/CSS/JS 實現（當前版本）


